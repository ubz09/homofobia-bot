<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HMFB Client ‚Äî Inicio</title>

<!-- jsPDF para comprobante -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  :root{--violet:#b300ff;--glow:#ff66ff}
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:"Poppins",sans-serif;background:radial-gradient(circle at top,#0a0010 0%,#000 100%);color:#fff;min-height:100vh;overflow-x:hidden}
  header{position:sticky;top:0;z-index:50;display:flex;justify-content:center;gap:20px;padding:12px 8px;background:rgba(6,0,10,0.5);border-bottom:1px solid rgba(179,0,255,0.08)}
  header a{color:#fff;text-decoration:none;font-weight:700;padding:8px 12px;border-radius:999px}
  header a:hover{color:var(--glow);text-shadow:0 0 8px rgba(179,0,255,0.14)}
  .page{padding:80px 16px 48px;display:flex;flex-direction:column;align-items:center;gap:18px}
  .logo{width:220px;filter:drop-shadow(0 0 18px rgba(179,0,255,0.16))}
  .container{width:100%;max-width:1100px;display:grid;grid-template-columns:1fr 420px;gap:20px;margin-top:8px}
  @media(max-width:980px){.container{grid-template-columns:1fr;padding:0 12px}}
  .card{background:linear-gradient(180deg,rgba(18,3,25,0.65),rgba(8,0,10,0.55));border-radius:12px;padding:16px;border:1px solid rgba(187,0,255,0.08);box-shadow:0 12px 40px rgba(0,0,0,0.6)}
  h1{font-family:'Brush Script MT',cursive;color:var(--violet);font-size:2.2rem;text-shadow:0 0 12px rgba(179,0,255,0.12);text-align:center}
  .muted{color:#dcd2ff}
  label{display:block;margin-top:10px;color:#e6dbff}
  input[type="text"],input[type="password"],input[type="email"]{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#fff;margin-top:8px}
  .btn{padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--violet),#ff66ff);color:#fff;cursor:pointer;font-weight:700;box-shadow:0 8px 24px rgba(179,0,255,0.12)}
  .plans{display:flex;flex-direction:column;gap:12px}
  .plan{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(30,0,60,0.45),rgba(20,0,40,0.4));border:1px solid rgba(187,0,255,0.06)}
  .price{font-weight:800;color:#ffccff}
  .small{font-size:0.92rem;color:#cfc9df}
  #particles{position:fixed;inset:0;z-index:-10}
  .center{display:flex;justify-content:center;align-items:center}
  #successMsg{display:none;text-align:center;color:#00ff88;font-size:1.6rem;font-weight:700;margin-top:20px;}
  #discordStatus{margin-top:10px;font-size:0.9rem;}
</style>
</head>
<body>

<canvas id="particles"></canvas>

<header>
  <a href="index.html">Inicio</a>
  <a href="staff.html">Staff</a>
  <a href="foro.html">Foro</a>
  <a href="https://discord.gg/6X4KV3TegR" target="_blank" rel="noopener">Discord</a>
</header>

<div class="page">
  <img src="assets/logo.png" alt="HMFB Logo" class="logo">

  <h1>HMFB Client - El Client m√°s avanzado y actualizado en 2025</h1>
  <p class="muted center">Accede a tus compras, genera comprobantes y √∫nete a la comunidad.</p>

  <div class="container">

    <!-- LEFT: login + info -->
    <div>
      <div class="card">
        <strong>Conectar con Discord</strong>
        <p id="discordStatus">Cargando...</p>
        <button id="discordLogin" class="btn" style="display:none;">Conectar con Discord</button>
      </div>

      <div class="card" style="margin-top:12px">
        <strong>Comprobantes guardados</strong>
        <div id="receiptArea" style="margin-top:8px" class="small">Sin compras todav√≠a.</div>
      </div>

      <div class="card" style="margin-top:12px">
        <strong>Panel de usuario</strong>
        <div id="panelArea" style="margin-top:8px" class="small">Inicia sesi√≥n con Discord para ver tu panel.</div>
      </div>
    </div>

    <!-- RIGHT: plans -->
    <div class="card">
      <strong>Planes de Suscripci√≥n</strong>
      <p class="small">Selecciona y realiza el pago ‚Äî el rol ser√° otorgado autom√°ticamente en Discord.</p>

      <div class="plans" style="margin-top:12px">
        <div class="plan"><div><div style="font-weight:800">‚ö° 1 Mes</div><div class="small">Acceso b√°sico 30 d√≠as</div></div><div style="text-align:right"><div class="price">$5 USD</div><button class="btn" onclick="buyPlan('1mes')">Comprar</button></div></div>
        <div class="plan"><div><div style="font-weight:800">‚ö° 3 Meses</div><div class="small">Ahorra ‚Äî mejor valor</div></div><div style="text-align:right"><div class="price">$12 USD</div><button class="btn" onclick="buyPlan('3meses')">Comprar</button></div></div>
        <div class="plan"><div><div style="font-weight:800">‚ö° 6 Meses</div><div class="small">Soporte prioritario</div></div><div style="text-align:right"><div class="price">$20 USD</div><button class="btn" onclick="buyPlan('6meses')">Comprar</button></div></div>
        <div class="plan"><div><div style="font-weight:800">‚ö° Permanente</div><div class="small">Acceso de por vida</div></div><div style="text-align:right"><div class="price">$35 USD</div><button class="btn" onclick="buyPlan('permanente')">Comprar</button></div></div>
      </div>

      <div id="successMsg">‚úÖ Rol asignado correctamente</div>
    </div>

  </div>
</div>

<script>
const API_URL = "https://hmfb-production.up.railway.app"; // ‚ö†Ô∏è c√°mbialo si tu URL es distinta

/* -------- Discord Login -------- */
async function handleDiscordLogin() {
  const storedId = localStorage.getItem("discordId");
  const status = document.getElementById("discordStatus");
  const btn = document.getElementById("discordLogin");

  const params = new URLSearchParams(window.location.search);
  const code = params.get("code");

  if (storedId && !code) {
    status.innerHTML = `‚úÖ Conectado (ID: ${storedId})`;
    return;
  }

  if (code) {
    status.innerHTML = "Procesando login...";
    try {
      const res = await fetch(`${API_URL}/auth/discord/callback?code=${code}`);
      const data = await res.json();
      if (data.id) {
        localStorage.setItem("discordId", data.id);
        status.innerHTML = `‚úÖ Conectado como ${data.username} (ID: ${data.id})`;
        btn.style.display = "none";
        window.history.replaceState({}, document.title, "/");
      } else {
        status.innerHTML = "‚ùå Error al conectar.";
        btn.style.display = "block";
      }
    } catch (err) {
      console.error(err);
      status.innerHTML = "‚ùå No se pudo conectar al servidor.";
      btn.style.display = "block";
    }
  } else {
    status.innerHTML = "üîó No conectado a Discord.";
    btn.style.display = "inline-block";
    btn.onclick = () => { window.location.href = `${API_URL}/auth/discord`; };
  }
}

/* -------- Part√≠culas -------- */
const canvas=document.getElementById('particles'),ctx=canvas.getContext('2d');
let W=canvas.width=innerWidth,H=canvas.height=innerHeight;
window.addEventListener('resize',()=>{W=canvas.width=innerWidth;H=canvas.height=innerHeight;initParticles();});
function rand(min,max){return Math.random()*(max-min)+min}
let particles=[];
function initParticles(){particles=[];const NUM=Math.max(40,Math.floor((W*H)/120000));for(let i=0;i<NUM;i++){particles.push({x:Math.random()*W,y:Math.random()*H,vx:(Math.random()-0.5)*0.6,vy:-(0.2+Math.random()*0.6),r:0.6+Math.random()*2.2,hue:270+Math.random()*30,a:0.25+Math.random()*0.6})}}
initParticles();
function draw(){ctx.clearRect(0,0,W,H);for(let p of particles){p.x+=p.vx;p.y+=p.vy;if(p.y<-50){p.y=H+20;p.x=Math.random()*W}if(p.x<-20)p.x=W+20;if(p.x>W+20)p.x=-20;ctx.beginPath();ctx.fillStyle='hsla('+p.hue+',85%,'+(35+(p.r*2))+'%,'+p.a+')';ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();}requestAnimationFrame(draw);}draw();

/* -------- Sistema de compras -------- */
const RECEIPT_KEY='hmfb_receipts_v2';let receipts=JSON.parse(localStorage.getItem(RECEIPT_KEY)||'[]');
function persistReceipts(){localStorage.setItem(RECEIPT_KEY,JSON.stringify(receipts));}
function formatDateISO(d){return d?new Date(d).toLocaleString():'Sin caducidad';}

async function buyPlan(paquete){
  const discordId=localStorage.getItem('discordId');
  if(!discordId)return alert("‚ö†Ô∏è Conecta primero tu cuenta de Discord.");
  const user=discordId;
  try{
    const res=await fetch(`${API_URL}/assign-role`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({discordId,paquete})});
    const data=await res.json();
    if(data.ok){
      showSuccess();
      const purchaseDate=new Date();
      const days=paquete==='1mes'?30:paquete==='3meses'?90:paquete==='6meses'?180:null;
      const expiration=days?new Date(purchaseDate.getTime()+days*86400000):null;
      const price=paquete==='1mes'?5:paquete==='3meses'?12:paquete==='6meses'?20:35;
      const id='HMFB-'+Math.floor(Math.random()*900000+100000);
      const receipt={id,user,plan:paquete,purchaseDate:purchaseDate.toISOString(),expiration:expiration?expiration.toISOString():null,price};
      receipts.push(receipt);persistReceipts();renderReceipts();generateReceiptPDF(receipt);
    }else{alert("‚ö†Ô∏è Error: "+data.error);}
  }catch(err){alert("‚ùå No se pudo conectar al bot.");console.error(err);}
}

function showSuccess(){
  const el=document.getElementById("successMsg");
  el.style.display='block';el.style.opacity=0;el.style.transition='opacity 1.5s ease';
  setTimeout(()=>{el.style.opacity=1;},100);
  setTimeout(()=>{el.style.opacity=0;el.style.display='none';},6000);
}

function renderReceipts(){const area=document.getElementById('receiptArea');if(!receipts.length){area.innerHTML='<div class="small">Sin compras.</div>';return;}const last=receipts[receipts.length-1];area.innerHTML=`<div><strong>√öltimo comprobante:</strong><br>ID: ${last.id}<br>Plan: ${last.plan}<br>Compra: ${formatDateISO(last.purchaseDate)}<br>Expira: ${formatDateISO(last.expiration)}</div>`;}

async function generateReceiptPDF(receipt){const {jsPDF}=window.jspdf;const doc=new jsPDF({unit:'pt',format:'a4'});doc.setFillColor(18,0,30);doc.rect(0,0,595,72,'F');doc.setFontSize(18);doc.setTextColor(187,0,255);doc.setFont('helvetica','bold');doc.text('HMFB - Comprobante de compra',150,36);let y=100;doc.setFillColor(6,0,12);doc.roundedRect(40,y,515,200,6,6,'F');doc.setDrawColor(80,20,100);doc.roundedRect(40,y,515,200,6,6);y+=22;doc.setFontSize(12);doc.setTextColor(255,255,255);doc.setFont('helvetica','normal');doc.text(`Comprobante ID: ${receipt.id}`,55,y);y+=18;doc.text(`Usuario Discord ID: ${receipt.user}`,55,y);y+=18;doc.text(`Plan: ${receipt.plan}`,55,y);y+=18;doc.text(`Fecha de compra: ${new Date(receipt.purchaseDate).toLocaleString()}`,55,y);y+=18;doc.text(`Expiraci√≥n: ${receipt.expiration?new Date(receipt.expiration).toLocaleString():'Sin caducidad'}`,55,y);y+=28;doc.setFont('helvetica','bold');doc.text(`Precio: $${receipt.price} USD`,420,150);doc.setFontSize(10);doc.setFont('helvetica','normal');doc.setTextColor(200,200,200);doc.text('HMFB Client ¬© 2025 ‚Äî Comprobante generado autom√°ticamente',55,340);doc.save(`${receipt.id}.pdf`);}

(function(){receipts=JSON.parse(localStorage.getItem(RECEIPT_KEY)||'[]');renderReceipts();handleDiscordLogin();})();
</script>
</body>
</html>

